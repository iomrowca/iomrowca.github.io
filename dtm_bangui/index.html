<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0" name="viewport">
    <title>DTM | Bangui</title>

    <!-- Bootstrap -->
    <link type="text/css" rel="stylesheet" href="css/bootstrap.css">
    <link type="text/css" href="css/leaflet.css" rel="stylesheet"/>
    <link type="text/css" href="css/leaflet.markercluster.css" rel="stylesheet"/>

    <link rel="stylesheet" type="text/css" href="css/dc.css">

    <style>
      #map {
        margin-left: 15px;
        width:450px;
        height:400px;
      }
      #data {
        height:400px;
        overflow-y: auto;
      }
    </style>

</head>


<body>
    <div style="display: block;" class="container" id="dashboard">
      <p id="title"><h3>DRAFT - Suivi Bangui DTM </h3></p>
                <div >
                    <h4>Number of IDPs in camps in Bangui <a href="https://docs.google.com/spreadsheets/d/1W2zayEHo0HCXmSs0e77qiSABYpRiNJmtAnBKZDXGhRs/edit#gid=0" target="_blank">Changer les donn√©es ici </a></h4>
                    <div class="row">
                      <div id="map" class="col-sm-6"></div>
                      <div id="data"class="col-sm-6" ></div>
                    </div>
                    <div id="timeline"><h4>&nbsp;<span class="filter"></span></h4></div>
                </div>

        <br><br>
        <!--<div id="reachbar"><a href="http://www.reach-initiative.org/"><img src="img/reach.jpg" style="background-color:#fff;border:none;height:40px" /></a></div>-->
        <br>
        
    </div>
    

    <script type="text/javascript" src="js/intro.js"></script>
    <script type="text/javascript" src="js/d3_002.js"></script>
    <script type="text/javascript" src="js/d3.js"></script>
    <script type="text/javascript" src="js/crossfilter.js"></script>
    <script type="text/javascript" src="js/dc.js"></script>
    <script type="text/javascript" src="js/jquery.js"></script>
    <script type="text/javascript" src="js/leaflet.js"></script>
    <script type="text/javascript" src="js/tabletop.js"></script>


<script type="text/javascript">
var a,b;
window.onload = function() { init() };
  
   //form google sheet / Not in Edition
   var poi_bangui    = 'https://docs.google.com/spreadsheets/d/1W2zayEHo0HCXmSs0e77qiSABYpRiNJmtAnBKZDXGhRs/pubhtml';

     function init() {
        Tabletop({
            key: poi_bangui,
            callback: showInfo,
            simpleSheet: false
        });   
      }
   
   function showInfo(datag, tabletop) {
   
    evol = datag.Evol;
    data = evol.elements;
    poi_gp = datag.POI; 
    poi = poi_gp.elements;
    needss=datag.Needs;
    needs=needss.elements;
    console.log(needs)
    // Gestionnaire 
    // Needs

    console.log(data)
    data.forEach(function(occurence) {

          var result = poi.filter(function(p) {
              return p.SSID === occurence.SSID;
          });

          //var agence = 

          //delete occurence.SSID;
          occurence.Name = (result[0] !== undefined) ? result[0].Name : null;
          occurence.lat = (result[0] !== undefined) ? result[0].lat : null;
          occurence.lng = (result[0] !== undefined) ? result[0].long : null;
          occurence.geo =  (result[0] !== undefined) ? result[0].lat +","+result[0].long : null;
          occurence.label =  (result[0] !== undefined) ? result[0].Name+","+result[0].lat +","+result[0].long+","+result[0].SSID : "Unknow,0,0";
   
   });

    $("#data").html("<small>Clicker sur un site pour avoir le detail des besoins humanitaires</small><br><hr>");
    
  dateEventChart  = dc.barChart("#timeline");
  var dateFormat = d3.time.format("%d/%m/%Y");

  var xf = crossfilter(data);

  var all  = xf.groupAll();
      

  var locations       = xf.dimension(function(d) { return d.geo; });
  
  var names           = xf.dimension(function(d) { return d.label; });

  var nameGroup = names.group().reduceSum(function(d) { return d.nb_idp; });
  
  //difference
  var nb_idpDim   = xf.dimension(function(d) { return +d.nb_idp; });
  var nb_idpGroup = nb_idpDim.group().reduceSum(function(d) { return +d.nb_idp; });


  var dateDIM     = xf.dimension(function(d){ return  dateFormat.parse(d.date) });
  var dateGroup   = dateDIM.group().reduceSum(function(d) { return +d.nb_idp; });

  
  dateEventChart
        .width(950)
        .height(100)
        .margins({top: 10, right: 30, bottom: 30, left: 35})
        .dimension(dateDIM)
        .group(dateGroup)   //.x(d3.time.scale())
        .x(d3.time.scale().domain([new Date(2015, 08, 01), new Date()]))
        .xUnits(function(){return 100;})
        .brushOn(true)
        .elasticY(false)
        //.y(d3.scale.linear().domain([90, 10000]))
        //.xAxis().ticks(5);
        .yAxis().ticks(4).tickFormat(d3.format("d"));
      
      dateEventChart.renderlet(function(chart){
          chart.selectAll("g line")
          //.style("stroke", "#000")
          //.ticks(d3.time.days,7)
      });


var info = L.control({
                position: 'topright'
            }); //, shown: false }); // { position: 'bottomleft' }

info.onAdd = function(map) {

  this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
          //this.options.shown = true;
  this.update();
  return this._div;
};

info.update = function(wpaTitle) {
      this._div.innerHTML = (wpaTitle ?
        '<b>' + wpaTitle + '</b>' : 'Hover over a Wathab Project');

};

function updateMapPoints() {
        
        wpaCluster.clearLayers();
        
        
        if (!map.hasLayer(wpaCluster)) return;
        map.removeLayer(wpaCluster);
        
        var markerList = [];

        nameGroup.top(Infinity).forEach(function(p) {
        //facilitiesGroup.top(Infinity).forEach(function(p) {
          console.log(p);

          var latlng = p.key.split(",");

          var name = (latlng[0] !== undefined) ? latlng[0] : null; 
          var lat = (latlng[1] !== "") ? latlng[1] : "0"; 
          var lng = (latlng[2] !== "") ? latlng[2] : "0"; 
          var ssid = (latlng[3] !== "") ? latlng[3] : null; 

          console.log(lat);
          console.log(lng);

          var wpaMarker = L.circleMarker([lat,lng], { fillColor: "#AAAAAA",color:"#004680",radius: Math.sqrt(p.value)/Math.sqrt(1000)*20}); // in lat-long

          wpaMarker.on('mouseover',function (e) {

            info.addTo(map);
            info.update(name + " : "+ p.value);
            
          });
          
          wpaMarker.on('mouseout',function (e) {
            info.update();
            info.removeFrom(map);
            //info.options.shown = false;
          });
          
          var count = 0;
          wpaMarker.on('click',function (e) {
              $("#data").empty();

              var needresult = needs.filter(function(p) {
                  //console.log(p)
                  return p.Code_Site === ssid;
              });

              console.log(needresult[0]);

              //var html = "";
              $.each( needresult[0], function( key, value ) {
                //console.log( key + ": " + value );
                $("#data").append(key+ " : " + value +"<hr>");
              });
              
              // needresult.forEach(function(occ) {
                    
              //   html = "Gestionnaire/Facilitation des sites"+ " : " + occ['Gestionnaire/Facilitation des sites'] +"<br>";
   
              // });

             //var div = document.getElementById('data');
              
             //var html = "<h3>" + name +"&nbsp;-&nbsp;"+ ssid +"</h3><br><hr>";


              //div.innerHTML = html;
          
          });



          markerList.push(wpaMarker);
          
          wpaCluster.addLayer(wpaMarker);

        });
        
        map.addLayer(wpaCluster);

      };

 
  $('#reset').on('click', function (){
    dc.filterAll();
    dc.redrawAll();
    return false;
  })


  dc.renderAll();

   var OpenStreetMap_HOT = L.tileLayer('http://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
       maxZoom: 19,
       attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, Tiles courtesy of <a href="http://hot.openstreetmap.org/" target="_blank">Humanitarian OpenStreetMap Team</a>'
   });

   var map = L.map('map',{maxZoom: 18,minZoom:12, layers: [OpenStreetMap_HOT]}).setView([4.379933,18.564533], 12);

   wpaCluster = L.featureGroup();
   map.addLayer(wpaCluster);

  updateMapPoints();
  
  for (var i = 0; i < dc.chartRegistry.list().length; i++) {
      var chartI = dc.chartRegistry.list()[i];
      chartI.on("filtered", function(chart, filter){ 
        dc.redrawAll();
        updateMapPoints();
      });
  }

};
//};

</script>

 <script src="js/bootstrap.js"></script>


</body>


</html>
