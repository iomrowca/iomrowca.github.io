<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0" name="viewport">
    <title>DTM | Bangui</title>

    <!-- Bootstrap -->
    <link type="text/css" rel="stylesheet" href="css/bootstrap.css">
    <link type="text/css" href="css/leaflet.css" rel="stylesheet"/>
    <link type="text/css" href="css/leaflet.markercluster.css" rel="stylesheet"/>

    <link rel="stylesheet" type="text/css" href="css/dc.css">

    <style>
      #map {
        margin-left: 15px;
        width:800px;
        height:600px;
      }
      #data {
        width:270px;
        height:600px;
        color:white;
        background-color: #3d3d3d;
        overflow-y: auto;

      }
      #infosite{
        width:270px;
        height:600px;
        color:white;
        background-color: #3d3d3d;
        overflow-y: auto;

      }
      #headerbox{
        height: 30px;
        background-color: #3d3d3d;
      }
      /*  a{
        color:#C0392B;
      }
      a:hover{
        color:#C0392B;
      }*/
      .info{
        color:#120029;
      }
      .dc-chart .grid-line {
        fill: none;
        stroke: #3d3d3d;
        opacity: 0.5;
        shape-rendering: crispedges;
      }
      .dc-chart .axis path, .axis line {
        fill: none;
        stroke: #3d3d3d;
        shape-rendering: crispedges;
    }
    </style>

</head>


<body>
    <div class="container">
      <p id="title"><h3><span style="color:#C0392B">DRAFT</span> - Suivi Bangui DTM </h3></p>
                <div >
                    <h4>Nombre de PDI dans les camps de Bangui <small><a href="https://github.com/iomrowca/dtm_bangui/archive/master.zip">Telecharger la version OFFLINE</a></small></h4>
                    <div class="row">
                      <div id="map" class="col-md-8"></div>
                      <div id="info" style="display:none">
                        <div id="data"class="col-md-3">
                          <div id='numbertot'><span><small>Total PDI : </small></span></div>
                          <div id='numbertot'><span><small>Total PDI avant sept 2015: </small></span></div>
                          <div id='numbertot'><span><small>Total PDI après sept 2015: </small></span></div>
                          <hr><br>
                          <span><small>Tendance </small></span><span id ="reset"><small><a>(Reset)</a></small></span><div id='evolution'></div>
                        </div>
                      </div>
                    </div>
                    <!--<div id="timeline"><h4><span class="filter"></span></h4></div>-->
                </div>

        <br><br>
        <!--<div id="reachbar"><a href="http://www.reach-initiative.org/"><img src="img/reach.jpg" style="background-color:#fff;border:none;height:40px" /></a></div>-->
        <br>
        
    </div>
    

    <script type="text/javascript" src="js/intro.js"></script>
    <script type="text/javascript" src="js/d3_002.js"></script>
    <script type="text/javascript" src="js/d3.js"></script>
    <script type="text/javascript" src="js/crossfilter.js"></script>
    <script type="text/javascript" src="js/dc.js"></script>
    <script type="text/javascript" src="js/jquery.js"></script>
    <script type="text/javascript" src="js/leaflet.js"></script>
    <script type="text/javascript" src="js/tabletop.js"></script>


<script type="text/javascript">

//window.onload = function() { init() };
  
  // var poi_bangui    = 'https://docs.google.com/spreadsheets/d/1W2zayEHo0HCXmSs0e77qiSABYpRiNJmtAnBKZDXGhRs/pubhtml';
  //   function init() {
  //     Tabletop({
  //         key: poi_bangui,
  //         callback: showInfo,
  //         simpleSheet: false
  //     });   
  //   };
   
  // function showInfo(datag, tabletop) {
  //   //Get all the data form the tabs in 3 arrays.
  //   evol = datag.Evol;
  //   data = evol.elements;
  //   poi_gp = datag.POI; 
  //   poi = poi_gp.elements;
  //   needss=datag.Needs;
    //needs=needss.elements;

  scsv = d3.dsv(';', "text/csv; charset=ISO-8859-1");

    scsv("data/car_diff_modif.csv", function(data) {

    scsv("data/needs.csv", function(needs) {
    
    scsv("data/bangui_poi.csv", function(poi) {

      $("#info").css("display","block") 
    //Add the Lat and Long to the Evolution:
    data.forEach(function(occurence) {

      //Join the values with the SSID
      var result = poi.filter(function(p) {
        return p.SSID === occurence.SSID;
      });

      occurence.Name = (result[0] !== undefined) ? result[0].Name : null;
      occurence.lat = (result[0] !== undefined) ? result[0].lat : null;
      occurence.lng = (result[0] !== undefined) ? result[0].long : null;
      occurence.geo =  (result[0] !== undefined) ? result[0].lat +","+result[0].long : null;
      occurence.label =  (result[0] !== undefined) ? result[0].Name+","+result[0].lat +","+result[0].long+","+result[0].SSID : "Unknow,0,0";
          //occurence.totnb = (nb_total[0] !== undefined) ? nb_total[0]['Total des PDIs'] : null;
    });

    //Add the lat and Long to the needs:
    needs.forEach(function(need_camp) {
      //Join the values with the SSID
      //TODO Clean the SSID in the google sheet 
      var resjoin = poi.filter(function(p) {
        return p.SSID === need_camp.Code_Site;
      });
      need_camp.lat = (resjoin[0] !== undefined) ? resjoin[0].lat : null;
      need_camp.lng = (resjoin[0] !== undefined) ? resjoin[0].long : null;
      need_camp.geo =  (resjoin[0] !== undefined) ? resjoin[0].lat +","+resjoin[0].long : null;
      need_camp.label =  (resjoin[0] !== undefined) ? resjoin[0].Name+","+resjoin[0].lat +","+resjoin[0].long+","+resjoin[0].SSID+","+need_camp['Total des PDIs'] : "Unknow,0,0,Unknow,Unknow";
    });


    
    dateEventChart  = dc.barChart("#timeline");
    numbertot = dc.numberDisplay("#numbertot");
    evolutionChart = dc.rowChart("#evolution");


    var dateFormat = d3.time.format("%d/%m/%Y");

    var xf = crossfilter(data);

    var all  = xf.groupAll();
    
    var ndx = crossfilter(needs);

    var locations       = xf.dimension(function(d) { return d.geo; });
    var location_tot    = ndx.dimension(function(d) { return d.geo; });

    var names           = xf.dimension(function(d) { return d.label; });
    var names_tot       = ndx.dimension(function(d) { return d.label; });

    var idp =  ndx.dimension(function(d) { return d['Total des PDIs'] });

    var nameGroup    = names.group().reduceSum(function(d) { return d.nb_idp; });
    var nametotGroup = names_tot.group().reduceSum(function(d) { return d['Total des PDIs'] ; });

    //difference
    var nb_idpDim   = xf.dimension(function(d) { return +d.nb_idp; });
    var nb_idpGroup = nb_idpDim.group().reduceSum(function(d) { return +d.nb_idp; });


    var dateDIM     = xf.dimension(function(d){ return  dateFormat.parse(d.date) });
    var dateGroup   = dateDIM.group().reduceSum(function(d) { return +d.nb_idp; });

        //console.log(data)
    $("#data").prepend("<br><small>Cliquer sur un site pour avoir le detail des besoins humanitaires</small><br><hr>");
    
    totalidp_DimGroup = ndx.groupAll().reduce(function (p, v) { ++p.n;p.tot += +v['Total des PDIs'] ; return p;},function (p, v) {--p.n;p.tot -= +v['Total des PDIs'] ;return p;},function () { return {n:0,tot:0}; });
    
    totalidpavtspet_DimGroup = ndx.groupAll().reduce(function (p, v) { ++p.n;p.tot += +v['Nombre de Population avant la crise du 26 Septembre 2015'] ; return p;},function (p, v) {--p.n;p.tot -= +v['Nombre de Population avant la crise du 26 Septembre 2015'] ;return p;},function () { return {n:0,tot:0}; });

    //Nombres des PDIs ajouté aprèss la crise

    var total_Dim = function(d) { return +d.tot};
    var total_sites = function(d) { return +d.n};

    numbertot.group(totalidp_DimGroup).valueAccessor(total_Dim).formatNumber(d3.format(",.0f"));

    console.log(needs)
    //EVOLUTION
    
    var evolutionDim   = ndx.dimension(function(d) { return d.Tendency; });
    var evolutiongroup = evolutionDim.group();

    evolutionChart
          .width(235)
          .height(350)
          .margins({top: 10, right: 0, bottom: 0, left: 0})
          .dimension(evolutionDim)
          .group(evolutiongroup)   //.x(d3.time.scale())

        evolutionChart.renderlet(function(chart){
            chart.selectAll("g line")
            //.style("stroke", "#000")
            //.ticks(d3.time.days,7)
        });

    dateEventChart
          .width(900)
          .height(100)
          .margins({top: 10, right: 30, bottom: 30, left: 35})
          .dimension(dateDIM)
          .group(dateGroup)   //.x(d3.time.scale())
          .x(d3.time.scale().domain([new Date(2015, 08, 01), new Date()]))
          .xUnits(function(){return 100;})
          .brushOn(true)
          .elasticY(false)
          //.y(d3.scale.linear().domain([90, 10000]))
          //.xAxis().ticks(5);
          .yAxis().ticks(4).tickFormat(d3.format("d"));
        
        dateEventChart.renderlet(function(chart){
            chart.selectAll(".grid-line")
            .style("stroke", "#3D3D3D")
            //.ticks(d3.time.days,7)
        });


      var info = L.control({
                      position: 'topright'
                  }); //, shown: false }); // { position: 'bottomleft' }

      info.onAdd = function(map) {

        this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
                //this.options.shown = true;
        this.update();
        return this._div;
      };

      info.update = function(wpaTitle) {
            this._div.innerHTML = (wpaTitle ?
              '<b>' + wpaTitle + '</b>' : 'Hover over a Wathab Project');

      };


function resetColors() {
    for (var i = 0; i < map._layers; i++) {
        layers[i].properties['marker-color'] = geoJson[i].properties['old-color'] ||
            geoJson[i].properties['marker-color'];
    }
    //myLayer.setGeoJSON(geoJson);
}


function updateMapPoints() {
        
        wpaCluster.clearLayers();
        
        if (!map.hasLayer(wpaCluster)) return;
        map.removeLayer(wpaCluster);
        
        var markerList = [];

        nametotGroup.top(Infinity).forEach(function(p) {

          var latlng = p.key.split(",");

          var name = (latlng[0] !== undefined) ? latlng[0] : null; 
          var lat = (latlng[1] !== "") ? latlng[1] : "0"; 
          var lng = (latlng[2] !== "") ? latlng[2] : "0"; 
          var ssid = (latlng[3] !== "") ? latlng[3] : null; 

          var wpaMarker = L.circleMarker([lat,lng], { fillColor: "#ECF0F1",color:"#C0392B",radius: Math.sqrt(p.value)/Math.sqrt(2000)*20}); // in lat-long

            wpaMarker.on('mouseover',function (e) {

              info.addTo(map);
              info.update(name + " : "+ p.value);
              
            });
          
            wpaMarker.on('mouseout',function (e) {
              info.update();
              info.removeFrom(map);
              //info.options.shown = false;
            });
          
            wpaMarker.on('click',function (e) {
              //console.log(e.target._path.attributes);
              //var stroke_w = e.target._path.attributes;
              //stroke_w[5].value=5;
              //lay = map._layers[23]._layers;
              //console.log(e);
  

              //stroke_w.getNamedItem(name)
              $("#data").hide();
              $("#infosite").remove();
              //$("#info").css("width","270px");

              var needresult = needs.filter(function(p) {
                  return p.Code_Site === ssid;
              });
              $("#info").append("<div id='infosite'class='col-md-3'><div id ='headerbox'><svg version='1.1' id='Layer_1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' x='0px' y='0px'viewBox='-79 24.3 312 76' enable-background='new -79 24.3 312 76' xml:space='preserve'><g><g><g><path d='M193.5,82.5c-11.2,0-20.2-9.1-20.2-20.2s9.1-20.2,20.2-20.2c11.2,0,20.2,9.1,20.2,20.2S204.7,82.5,193.5,82.5z M193.5,46.5c-8.7,0-15.7,7.1-15.7,15.7S184.8,78,193.5,78c8.7,0,15.7-7.1,15.7-15.7S202.2,46.5,193.5,46.5z'/></g><polygon points='204.1,54.9 200.9,51.7 193.5,59.1 186.1,51.7 182.9,54.9 190.3,62.3 182.9,69.7 186.1,72.9 193.5,65.5 200.9,72.9 204.1,69.7 196.7,62.3'/></g></g></svg></div><br></div>");
              $.each( needresult[0], function( key, value ) {
                $("#infosite").append("<small>"+key+ " : " + value +"</small><hr>");
              }); 
              $("#headerbox").on("click", function(){
                $("#infosite").hide();
                $("#data").show();

              });
          
            },function (e) {
              var stroke_w = e.target._path.attributes;
              stroke_w[5].value=2;
            });



          markerList.push(wpaMarker);
          
          wpaCluster.addLayer(wpaMarker);

        });
        
      map.addLayer(wpaCluster);

  };

 
  $('#reset').on('click', function (){
    dc.filterAll();
    dc.redrawAll();
    return false;
  })


  dc.renderAll();

   var OpenStreetMap_HOT = L.tileLayer('http://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
       maxZoom: 19,
       attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, Tiles courtesy of <a href="http://hot.openstreetmap.org/" target="_blank">Humanitarian OpenStreetMap Team</a>'
   });

   var imageUrl = 'image/bangui_map.png',
    imageBounds = [[4.5193,18.40957 ], [4.2854,18.7103]];

  var offlineimage = L.imageOverlay(imageUrl, imageBounds);

   var map = L.map('map',{maxZoom: 18,minZoom:12, layers: offlineimage}).fitBounds(imageBounds);

   wpaCluster = L.featureGroup();
   map.addLayer(wpaCluster);

  updateMapPoints();
  
  for (var i = 0; i < dc.chartRegistry.list().length; i++) {
      var chartI = dc.chartRegistry.list()[i];
      chartI.on("filtered", function(chart, filter){ 
        dc.redrawAll();
        updateMapPoints();
      });
  }
});
});
});

</script>

 <script src="js/bootstrap.js"></script>


</body>


</html>
